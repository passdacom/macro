# 고급 매크로 프로그램 개발 기록

## 1. 프로젝트 개요

(기존 내용과 동일...)

## 2. 개발 환경

(기존 내용과 동일...)

## 3. 단계별 개발 과정 및 트러블슈팅

(중략...)

## 7. 추가 기능 개발 및 현재 상태 (v2.5)

안정화된 v2.0 버전을 기반으로, 사용 편의성과 프로그램의 활용도를 극대화하기 위한 고급 기능들을 단계적으로 추가했다. 각 단계별로 발생한 문제점과 해결 과정을 상세히 기록한다.

### 7.1. 매크로 편집기 고급 기능 (v2.1)

*   **목표:** 사용자가 녹화된 매크로의 내용을 GUI에서 직접 확인하고, 불필요한 단계를 삭제하거나 시간 지연(딜레이), 액션의 속성까지 직접 수정할 수 있도록 하여 매크로 제작의 유연성을 극대화한다.
*   **구현 내용:**
    *   `tkinter.ttk.Treeview` 위젯의 항목을 더블 클릭하면, 시간과 액션 속성을 모두 편집할 수 있는 **통합 '액션 편집기' 창**이 열리도록 구현했다.
    *   **마우스 액션 편집:** 액션 편집기에서 마우스 클릭의 종류(Single/Double)와 버튼(Left/Right)을 변경할 수 있는 기능을 추가했다.
    *   **키보드 액션 편집:** 액션 편집기에서 단일 키 입력을 다른 키로 변경하는 기능을 추가했다.
    *   **데이터 구조 리팩토링:** 편집 기능의 안정성을 위해, 모든 그룹화된 액션이 내부에 명시적인 `type` 속성(예: `mouse_click`, `key_press`)을 갖도록 `event_grouper.py`의 데이터 구조를 개선했다.

### 7.2. 재생 편의 기능 (v2.2)

*   **재생 속도 조절:** GUI에 스핀박스를 추가하여 0.1x ~ 5.0x 까지 재생 속도를 조절하는 기능을 구현했다.
*   **안정성 강화:** 고속 재생 시에도 정지 단축키가 즉시 반응하도록 `event_player.py`의 스레드 처리 로직을 개선했다.

### 7.3. 로깅 시스템 강화 (v2.3)

*   **타임스탬프:** 모든 로그 메시지 앞에 `[YYYY-MM-DD HH:MM:SS]` 형식의 시간을 추가했다.
*   **로그 파일 저장:** 모든 로그를 GUI에 표시하는 동시에 `macro_log.txt` 파일에 자동으로 누적하여 기록하도록 했다.
*   **상세 정보 로깅:** 숫자패드 문제 등 디버깅을 용이하게 하기 위해, 키보드 이벤트 발생 시 `name`과 `scan_code`를 포함한 상세 정보가 로그에 남도록 수정했다.

### 7.4. 식별된 문제점 및 해결 과정

*   **문제 1: 숫자패드 입력 재생 오류**
    *   **현상:** `NumLock` 키 상태에 따라 숫자패드 키가 숫자가 아닌 방향키 등으로 잘못 재생되는 문제가 있었다.
    *   **원인:** 녹화 시점과 재생 시점의 `NumLock` 상태가 달랐기 때문이다. `keyboard` 라이브러리가 기록된 `scan_code`를 재생할 때 `NumLock`의 영향을 받았다.
    *   **해결:** `event_recorder.py`에서 숫자패드 키(`scan_code` 기준)가 입력되면, 이를 즉시 일반 숫자 키의 `scan_code`와 `name`을 가진 이벤트로 **정규화(Normalize)**하여 저장하도록 수정했다. 이를 통해 `NumLock` 상태와 무관하게 항상 올바른 숫자가 재생되도록 문제를 해결했다.

*   **문제 2: 액션 편집 후 재생 오류**
    *   **현상:** 편집기에서 키보드 액션을 'a'에서 'd'로 수정해도, 재생 시에는 여전히 'a'가 입력되었다.
    *   **원인:** 액션 수정 시 이벤트의 `name` 속성만 바꾸고, 재생에 실질적인 영향을 주는 `scan_code`는 변경하지 않았기 때문이다.
    *   **해결:** `app_gui.py`의 액션 수정 로직에 `keyboard.key_to_scan_codes()` 함수를 사용하여, 새로운 키의 `name`에 맞는 `scan_code`를 찾아 함께 업데이트하도록 수정하여 문제를 해결했다.

### 7.5. 매크로 에디터 UI 개선 (v2.5)

*   **목표:** 매크로 에디터의 가독성과 사용 편의성을 향상시킨다.
*   **구현 내용:**
    *   **No. 열 추가:** `Treeview`의 가장 왼쪽에 'No.' 열을 추가하여 각 액션의 순번을 명확하게 표시했다.
    *   **자동 넘버링:** 매크로를 녹화하거나, 불러오거나, 기존 액션을 삭제할 때마다 'No.'가 1부터 순서대로 다시 부여되도록 `_populate_treeview` 메서드를 수정했다. 이를 통해 사용자는 항상 정확한 순번을 확인할 수 있다.

*   **문제 3: 빠른 타이핑 시 그룹화 오류 (현재 해결 대상)**
    *   **현상:** `1`, `2`를 매우 빠르게 타이핑하면 `1 down` -> `2 down` -> `1 up` -> `2 up` 순서로 이벤트가 기록되어, `Key Press: 1`이 `2 down`까지 포함하는 등 그룹화가 깨지는 현상이 발생한다.
    *   **원인:** 현재 `event_grouper.py`의 그룹화 로직이 순차적 패턴 분석에만 의존하여, 이렇게 겹쳐서 들어오는 이벤트를 처리하지 못하는 근본적인 한계가 있다.

---

## 8. 향후 계획

### 8.1. 최우선 과제

*   **`event_grouper.py` 알고리즘 재설계:**
    *   **목표:** 빠른 타이핑 시 발생하는 이벤트 겹침 현상을 근본적으로 해결한다.
    *   **방법:** 현재의 순차적 패턴 매칭 방식에서 벗어나, "현재 눌려있는 키"의 상태를 추적하는 새로운 상태 기반 알고리즘을 도입한다. 이를 통해 `down` 이벤트와 `up` 이벤트의 짝을 정확히 찾아내어 올바르게 `Key Press` 액션을 그룹화한다.

### 8.2. 추가 기능 목록

*   **이미지 서치 기능 구현:** `pyautogui` 또는 `opencv-python`을 활용한 이미지 기반 매크로 기능을 추가한다.
*   **부분 반복 기능:** 매크로 편집기에서 특정 구간을 선택하여 해당 부분만 지정된 횟수만큼 반복 실행하는 기능을 구현한다.
*   **매크로 호출 기능:** 자주 사용하는 동작(예: 로그인)을 별도의 매크로로 저장하고, 다른 매크로 작업 중에 불러와 재사용하는 기능을 구현한다.
*   **사용자 편의 기능:**
    *   단축키 변경 기능
    *   시스템 트레이 최소화
    *   상태 표시줄 개선
*   **패키징:** 모든 기능이 안정화되면 최종 실행 파일로 패키징한다.
