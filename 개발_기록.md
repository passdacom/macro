# 개발 기록 (2025-11-19)

## 목표
마우스/키보드 매크로 프로그램의 이벤트 그룹화 로직을 개선하여 더블클릭, 단축키, 드래그 등의 사용자 액션을 정확하게 인식하고 재생하는 것을 목표로 하였습니다.

## 초기 문제점
사용자로부터 다음과 같은 문제점들이 보고되었습니다.
1.  **더블클릭 인식 실패**: 더블클릭이 두 개의 단일 클릭으로 잘못 인식되는 문제.
2.  **단축키 인식 오류**: `Ctrl+C`, `Ctrl+V` 등의 단축키가 제대로 그룹화되지 않고, 일부 키(주로 `up` 이벤트)가 누락되는 문제.
3.  **`Win+V` 오작동**: `Win+V` 단축키 사용 후 마우스 클릭 시, 의도치 않은 `Ctrl+V` 이벤트가 발생하는 문제.
4.  **불안정한 이벤트 기록**: 이벤트 기록 자체가 불안정하여 키보드 `up` 이벤트가 누락되는 등 원시 데이터의 무결성이 확보되지 않는 문제.

## 개발 과정 및 변경 내역

### 1차 시도: `new_event_grouper.py` 전면 재작성 (실패)

-   **내용**: 사용자의 명확한 로직 설명(더블클릭, 트리플클릭, 단축키 규칙)에 따라 `new_event_grouper.py`의 `group_events_statefully` 함수를 포함한 전체 로직을 재작성했습니다.
-   **문제점**:
    -   코드를 재작성하는 과정에서 `KeyError`가 발생하는 등 기본적인 문법 오류가 있었습니다.
    -   오류 수정 후에도 더블클릭 및 단축키 그룹화가 여전히 불안정했고, 로그 분석 결과 많은 `Unprocessed` 이벤트가 확인되었습니다.
-   **원인 분석**: 이벤트 그룹화 로직 자체가 너무 복잡하고, 다양한 예외 케이스를 처리하지 못하는 취약한 구조였습니다.

### 2차 시도: 이벤트 레코더 개선 (부분 성공 및 새로운 문제 발생)

-   **판단**: 그룹화 로직 이전에 원시 이벤트를 수집하는 `event_recorder.py` 단계에서부터 문제가 있을 것이라고 판단했습니다. 특히, 키보드 `up` 이벤트가 누락되는 현상에 주목했습니다.
-   **변경 내역**:
    1.  **`event_recorder.py` 수정 (1)**: `keyboard.hook` 대신 `queue.Queue`를 사용하여 이벤트를 비동기적으로 처리하도록 변경했습니다. 이는 스레드 충돌을 방지하고 이벤트 순서를 보장하기 위함이었습니다.
    2.  **`event_recorder.py` 수정 (2)**: 1번 방법으로도 `up` 이벤트 누락이 해결되지 않자, `keyboard.hook` 대신 `keyboard.is_pressed()`를 사용하는 폴링(polling) 방식으로 전면 교체했습니다.
-   **결과**:
    -   폴링 방식으로 변경 후, `ctrl down`, `ctrl up`, `c down`, `c up` 등 모든 원시 이벤트가 빠짐없이 기록되는 것을 로그를 통해 확인했습니다. **(성공)**
    -   하지만 `ctrl` 키를 누를 때 `left ctrl`, `right ctrl`, `ctrl` 이벤트가 모두 기록되고, `c` 키를 누를 때 `C`, `c`가 모두 기록되는 등, 이벤트가 중복되고 오염되는 새로운 문제가 발생했습니다.
-   **원인 분석**: 폴링 방식이 모든 키 상태를 확인하는 과정에서 `keyboard` 라이브러리가 여러 개의 이벤트를 동시에 생성하여 이벤트 스트림을 오염시키는 것으로 추정되었습니다.

### 3차 시도: 레코더 롤백 및 안정화, 그룹퍼 재도전 (실패)

-   **판단**: 오염된 이벤트 스트림으로는 정확한 그룹화가 불가능하다고 판단. 다시 `keyboard.hook` 방식으로 돌아가되, 안정성을 확보하는 방향으로 계획을 수정했습니다.
-   **변경 내역**:
    1.  **`main.py` 수정**: GUI 창 종료 시 `recorder.stop_recording()`이 반드시 호출되도록 `on_closing` 함수를 추가하여 훅(hook)이 정상적으로 해제되도록 보장했습니다. 이는 `up` 이벤트 누락의 근본적인 원인일 가능성이 높았습니다.
    2.  **`event_recorder.py` 수정**: `keyboard.hook`에 `suppress=True` 인자를 추가하여 운영체제(OS)와의 키 이벤트 처리 충돌 가능성을 원천적으로 차단했습니다.
    3.  **`new_event_grouper.py` 재작성**: 위 과정을 통해 깨끗하고 완전한 원시 이벤트 스트림을 확보한 후, 상태 머신(state machine) 기반의 더 단순하고 견고한 그룹화 로직을 다시 작성했습니다.
-   **결과**:
    -   원시 이벤트는 모두 정확하게 기록되었습니다.
    -   하지만 그룹화 로직은 여전히 `Unprocessed` 이벤트를 대량으로 발생시키고, `ctrl+c` 와 같은 기본적인 단축키조차 제대로 인식하지 못하는 등 총체적으로 실패했습니다.

## 최종 결론 및 롤백

수차례의 시도에도 불구하고 안정적인 그룹화 로직을 구현하는 데 실패했습니다. 특히 마지막 시도는 깨끗한 원시 데이터가 확보되었음에도 불구하고 그룹화 로직의 복잡성과 버그로 인해 문제를 해결하지 못했습니다.

이는 저의 디버깅 능력 부족과 성급한 판단이 원인이었습니다. 더 이상의 기능 개선 시도는 무의미하다고 판단하여, 사용자의 요청에 따라 모든 변경 사항을 폐기하고 문제가 발생하기 이전의 안정적인 버전 (`eec9dfe` 커밋)으로 코드를 롤백했습니다.

이번 개발 과정은 명확한 원인 분석과 테스트의 중요성을 다시 한번 상기시켜 주었습니다. 불안정한 기반 위에서 복잡한 로직을 구현하려 했던 것이 가장 큰 패인이었습니다.

다시 한번 프로젝트에 혼란을 드린 점에 대해 사과드립니다.

---
## 4차 시도: 그룹화 로직 재설계 및 플레이어 개선 (성공)

- **판단**: 이전의 실패는 그룹화 로직의 아키텍처 자체에 근본적인 결함이 있었기 때문이라고 판단. 특정 패턴을 순차적으로 찾는 방식 대신, 전체 이벤트 스트림을 순회하며 상태를 관리하는 **상태 머신(State Machine)** 방식으로 `event_grouper.py`를 완전히 재설계하기로 결정.
- **변경 내역**:
    1. **`event_grouper.py` 재작성**:
        - `IDLE`, `MOUSE_DOWN`, `KEY_DOWN`, `SEQUENCE` 등의 상태를 정의.
        - `group()` 메서드를 메인 컨트롤러로 사용하여, 이벤트 간의 시간 간격(`HUMAN_PAUSE_THRESHOLD`)을 체크해 액션의 완료 여부를 판단.
        - 시간 초과 시 버퍼를 안전하게 비우고 다음 액션을 처리하는 로직을 구현하여 'Unprocessed' 이벤트 발생을 최소화.
        - 더블클릭 로직을 수정하여, `down -> up`으로 생성된 '클릭' 액션을 후속 `double` 이벤트가 '더블클릭'으로 변경(mutate)하도록 수정. 이 과정에서 불필요한 `up` 이벤트가 재생되지 않도록 인덱스를 정확히 관리.
    2. **`event_recorder.py` 단순화**:
        - 새로운 그룹퍼가 더블클릭을 완벽하게 처리하므로, 기존 레코더에 남아있던 복잡한 더블클릭 예측 및 처리 로직을 모두 제거. 레코더는 이제 순수하게 원시 이벤트를 기록하는 역할에만 충실.
    3. **`event_player.py` 지능화**:
        - **트리플 클릭 버그 해결**: 플레이어가 그룹화된 액션의 `type`을 인지하도록 수정. `action.type`이 `mouse_double_click`이나 `mouse_drag`일 경우, 원시 이벤트를 재생하는 대신 `mouse.double_click()` 또는 `mouse.drag()`와 같은 고수준 명령을 직접 실행하도록 변경. 이로써 불필요한 이벤트 재생이 사라져 트리플 클릭 문제가 근본적으로 해결됨.
        - **마우스 이동 재생 버그 해결**: '액션 단위' 재생 로직 추가 시, '마우스 이동' 액션 내부의 각 이벤트마다 불필요한 지연 시간이 누적되어 재생이 느려지는 버그가 발생. 시간 계산 로직을 재생 시작 시간을 기준으로 각 이벤트의 절대적인 타임스탬프를 다시 계산하는 방식으로 수정하여 문제 해결.

- **결과**:
    - **성공**: 수차례의 테스트를 통해 더블클릭, 드래그, 단축키, 연속적인 키 입력('Typing') 등 대부분의 사용자 행동이 의도대로 정확하게 그룹화되고 재생되는 것을 확인.
    - **성공**: `Unprocessed` 이벤트가 거의 발생하지 않는 깔끔한 로그를 확보.
    - **성공**: 트리플 클릭 및 마우스 이동 지연 버그가 완전히 해결됨.
    - **결론**: 핵심 문제였던 그룹화 및 재생 로직이 안정화되었으며, 향후 기능 확장을 위한 견고한 기반이 마련됨.