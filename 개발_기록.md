# 고급 매크로 프로그램 개발 기록

## 1. 프로젝트 개요

### 1.1. 목표

사용자의 키보드 및 마우스 입력을 녹화하고, 이를 그대로 재생할 수 있는 안정적인 고급 매크로 프로그램을 개발한다. 이 프로그램은 사용 편의성을 위해 GUI를 제공하며, 다양한 부가 기능(반복 재생, 상대/절대 좌표, 단축키 제어, 파일 저장/불러오기)을 포함한다.

### 1.2. 핵심 아키텍처 원칙

본 프로젝트는 **순환 참조를 원천적으로 방지**하고 **모듈 간 결합도를 낮추기 위해** 다음과 같은 엄격한 아키텍처 원칙을 기반으로 설계되었다.

*   **단방향 의존성:** 모듈 간 의존성은 `main` -> `app_gui` -> `(event_recorder, event_player, hotkey_manager)` 방향으로만 흐른다. 하위 모듈은 절대로 상위 모듈을 직접 `import` 할 수 없다.
*   **콜백(Callback) 패턴:** 하위 모듈이 상위 모듈의 기능(예: GUI 업데이트)을 호출해야 할 경우, 상위 모듈이 자신의 메서드를 하위 모듈 생성 시 인자(콜백)로 전달한다. 이를 통해 의존성 역전 없이 통신한다.
*   **스레드 안정성:** GUI의 응답 없음을 방지하기 위해, 시간이 소요되는 모든 작업(녹화, 재생, 단축키 리스닝)은 별도의 스레드에서 실행한다.
*   **엄격한 진입점:** 프로그램 실행 코드는 오직 `main.py`의 `if __name__ == '__main__':` 블록 내에만 존재한다.

## 2. 개발 환경

*   **언어:** Python
*   **라이브러리:**
    *   `tkinter`: GUI 구현
    *   `keyboard`: 키보드 이벤트 처리 및 전역 단축키
    *   `mouse`: 마우스 이벤트 처리

## 3. 단계별 개발 과정 및 트러블슈팅

(중략...)

## 6. v2.0 최종 수정 과정 (주요 버그 해결)

최초 완성 후, 2개의 심각한 버그가 발견되어 이를 해결하는 과정을 기록한다.

### 6.1. 문제점 1: 더블 클릭 녹화/재생 오류

*   **현상:** 텍스트 위에서 더블 클릭하여 단어를 선택하는 동작을 녹화한 후 재생하면, 일반 클릭이 세 번 실행되어 문단 전체가 선택되는 등 오작동이 발생했다.
*   **원인 분석의 오류:**
    1.  **1차 시도 (재생기 수정):** 재생기가 이벤트 목록에서 `down-up-down-up` 패턴을 찾아 더블 클릭으로 "추측"하도록 수정했으나, 실제 사용자의 미세한 마우스 움직임(`MoveEvent`)이 중간에 끼어들면 패턴 감지에 실패했다.
    2.  **2차 시도 (녹화기 수정):** 녹화기가 `down` 이벤트 사이의 시간 간격만으로 더블 클릭을 "판단"하여 `DoubleClickEvent`라는 커스텀 이벤트를 만들도록 수정했다. 이 역시 `mouse` 라이브러리의 실제 동작 방식과 달라 문제를 더 복잡하게 만들었다.
*   **진짜 원인:** `mouse` 라이브러리는 더블 클릭이 발생하면 스스로 이를 감지하여, 두 번째 클릭의 `down` 이벤트 대신 `event_type`이 `'double'`인 `ButtonEvent`를 발생시킨다. 즉, 라이브러리가 이미 더블 클릭을 감지해주고 있었는데, 이를 모르고 직접 구현하려다 오히려 로직이 꼬인 것이 문제였다. 재생 시에는 `down`, `up`, `double` 이벤트를 모두 순차적으로 실행하여 총 3번의 클릭이 발생하는 결과를 낳았다.
*   **최종 해결책:**
    1.  **`event_recorder.py`:** 녹화기는 `double` 이벤트를 받으면, 이것이 더블 클릭임을 인지하고, 바로 직전에 기록되었던 불필요한 첫 번째 클릭의 `down`과 `up` 이벤트를 이벤트 목록에서 **삭제**한다.
    2.  또한, `double` 이벤트 이후에 따라오는 마지막 `up` 이벤트를 무시하도록 플래그를 설정한다.
    3.  **`event_player.py`:** 재생기는 `ButtonEvent`의 `event_type`을 확인하여, `'double'`이면 `mouse.double_click()`을, `'down'`이면 `mouse.press()`를, `'up'`이면 `mouse.release()`를 각각 실행하도록 역할을 명확히 분리했다.
    4.  결과적으로, 사용자가 더블 클릭을 하면 최종 이벤트 목록에는 **단 하나의 `double` 이벤트만** 깨끗하게 남아, 재생 시 정확히 한 번의 더블 클릭만 수행하게 되었다.

### 6.2. 문제점 2: 프로그램 종료 후 키 눌림 현상 (Stuck Keys)

*   **현상:** 프로그램을 종료한 후에도 `Shift`나 `Ctrl` 키가 계속 눌려있는 것처럼 시스템이 오작동하는 문제가 간헐적으로 발생했다.
*   **원인 분석:** `event_recorder`와 `hotkey_manager`는 백그라운드 스레드에서 키보드/마우스 이벤트를 감지하기 위해 시스템에 훅(Hook)을 설정한다. 프로그램 종료 시 이 훅을 안전하게 제거해야 하는데, 메인 프로그램(GUI)이 이 스레드들의 정리 작업이 **끝날 때까지 기다리지 않고** 먼저 종료해버리는 **경쟁 상태(Race Condition)**가 문제의 원인이었다. 운이 나쁘면 훅이 제거되기 전에 프로그램이 종료되어 시스템에 훅이 그대로 남게 되었다.
*   **최종 해결책:**
    1.  **`event_recorder.py`와 `hotkey_manager.py`의 `stop` 메서드를 수정**했다.
    2.  각 모듈의 `stop` 메서드가 호출되면, 단순히 스레드를 종료하라는 신호만 보내는 것이 아니라, 스레드의 `join()` 메서드를 호출하여 **해당 스레드가 모든 리소스(훅)를 완전히 해제하고 종료될 때까지 메인 스레드가 명시적으로 기다리도록** 변경했다.
    3.  이를 통해 프로그램이 종료될 때는 모든 백그라운드 작업이 100% 안전하게 정리된 후에야 GUI 창이 닫히도록 보장하여, 키 눌림 현상을 원천적으로 해결했다.

## 7. 추가 기능 개발 (v2.1 - v2.3)

안정화된 v2.0 버전을 기반으로, 사용 편의성과 프로그램의 활용도를 극대화하기 위한 고급 기능들을 단계적으로 추가했다. 각 단계별로 발생한 문제점과 해결 과정을 상세히 기록한다.

### 7.1. 매크로 편집기 (Macro Editor)

*   **목표:** 사용자가 녹화된 매크로의 내용을 GUI에서 직접 확인하고, 불필요한 단계를 삭제하거나 시간 지연(딜레이)을 수정할 수 있도록 하여 매크로 제작의 유연성을 극대화한다.
*   **구현 내용:**
    *   `app_gui.py`에 `tkinter.ttk.Treeview` 위젯을 추가하여 이벤트 목록을 표 형태로 표시했다.
    *   "선택 항목 삭제" 버튼을 추가하여 `macro_data`에서 해당 이벤트를 삭제하고 `Treeview`를 새로고침하는 기능을 구현했다.
*   **발생 문제점 및 해결:**
    *   **문제 1: `Mouse Move` 이벤트가 편집기 목록에 표시되지 않음.**
        *   **원인:** `_populate_treeview` 함수에서 `Mouse Move` 이벤트를 의도적으로 숨기도록 코딩했기 때문.
        *   **해결:** `_populate_treeview`에서 `Mouse Move` 이벤트를 숨기는 로직을 제거하여 모든 그룹화된 액션이 표시되도록 변경했다.
    *   **문제 2: `IndexError: list index out of range` 발생 및 삭제 기능 오작동.**
        *   **원인:** `_populate_treeview`에서 `Mouse Move` 이벤트를 숨기면서 `Treeview`의 `iid`와 `self.macro_data`의 실제 인덱스 간의 불일치가 발생했다. 이로 인해 `delete_selected_event`가 잘못된 인덱스에 접근하려 시도했다. 또한, 여러 항목을 동시에 삭제할 때 인덱스 변화를 제대로 처리하지 못하는 경쟁 상태가 있었다.
        *   **해결:**
            1.  `app_gui.py`에 `self.visible_actions` 리스트를 도입하여, `event_grouper.group_events()`가 반환하는 모든 그룹화된 액션을 이 리스트에 저장하도록 했다.
            2.  `_populate_treeview`는 `self.visible_actions`를 기반으로 `Treeview`를 채우고, `iid`를 `self.visible_actions`의 인덱스와 일치시켰다.
            3.  `delete_selected_event`는 `Treeview`에서 선택된 항목의 `iid`를 `self.visible_actions`의 인덱스로 사용하여 해당 액션의 `start_index`와 `end_index`를 얻어냈다.
            4.  삭제할 모든 원본 이벤트의 인덱스를 먼저 수집한 후, 역순으로 정렬하여 `macro_data`에서 안전하게 일괄 삭제하는 방식으로 로직을 재설계하여 경쟁 상태를 해결했다.

### 7.2. 이벤트 그룹화 (Event Grouping)

*   **목표:** 저수준(low-level) 이벤트를 고수준(high-level) 액션으로 묶어서 편집기 화면의 가독성과 사용성을 향상시킨다.
*   **구현 내용:**
    *   **모듈화:** `event_grouper.py`라는 별도의 모듈을 생성하여 이벤트 그룹화 로직을 분리했다.
    *   **그룹화 대상:** 단축키, 마우스 드래그, 마우스 이동, 마우스 휠 스크롤을 그룹화 대상으로 정의했다.
    *   **`GroupedAction` 데이터 클래스:** 그룹화된 액션의 정보를 담는 `GroupedAction` 클래스를 정의했다.
*   **발생 문제점 및 해결:**
    *   **문제 1: `Ctrl+C` 외의 단축키(예: `Ctrl+V`, `Ctrl+A`)가 그룹화되지 않음.**
        *   **원인:** 초기 `_find_shortcut` 로직이 `keyboard.is_modifier`와 같은 존재하지 않는 함수를 사용하거나, 키를 누르고 떼는 복잡한 순서(예: 여러 모디파이어, 키 떼는 순서)를 제대로 처리하지 못하는 등 매우 이상적인 패턴만 기대했기 때문.
        *   **해결:** `event_grouper.py`의 `_find_shortcut` 함수를 **상태 기반의 강력한 알고리즘으로 재설계**했다. 모디파이어 키가 눌리면 '단축키 모드'에 진입하고, 이 모드 동안 눌린 모든 모디파이어와 일반 키를 추적하여, 모든 모디파이어가 떨어질 때 최종 단축키 액션을 생성하도록 했다. 이로써 `Ctrl+Shift+Esc`와 같은 복잡한 단축키도 정확하게 그룹화할 수 있게 되었다.
    *   **문제 2: 마우스 드래그 및 휠 스크롤이 제대로 그룹화되지 않음.**
        *   **원인:** 초기 `_find_drag_or_click` 및 `_find_sequence` 로직이 패턴 감지에 충분히 견고하지 못했기 때문.
        *   **해결:** `event_grouper.py`의 `_find_drag_or_click` 및 `_find_sequence` 함수를 재설계하여, 마우스 드래그(버튼 누른 상태에서의 이동)와 휠 스크롤(연속적인 휠 이벤트)을 정확하게 감지하도록 개선했다.
    *   **문제 3: 마우스 휠 스크롤이 Up/Down 방향을 구분하지 못함.**
        *   **원인:** `_find_sequence` 함수가 휠 이벤트의 `delta` 값(방향) 변화를 고려하지 않고 연속성만 판단했기 때문.
        *   **결과:** `_find_sequence` 함수에 휠 이벤트의 `delta` 값을 확인하는 로직을 추가하여, 스크롤 방향이 바뀔 경우 새로운 그룹으로 분리하도록 했다.
    *   **문제 4: 단일 키보드 키(예: 'a')가 `down`, `up` 두 개의 이벤트로 분리되어 표시됨.**
        *   **원인:** `event_grouper.py`의 `group_events` 함수에서 단일 키보드 키의 `down` 및 `up` 이벤트를 하나의 액션으로 묶는 로직이 누락되었거나 잘못 구현되었기 때문.
        *   **해결:** `group_events` 함수 내부에 `_find_shortcut` 등 다른 패턴에 해당하지 않는 경우, 연속되는 `down` 및 `up` 키보드 이벤트를 찾아 `Key Press: [Key Name]` 형태로 그룹화하는 로직을 추가했다.

### 7.3. "항상 위" 기능 (Always on Top)

*   **목표:** 사용자의 필요에 따라 매크로 프로그램 창을 다른 모든 창 위에 항상 표시할 수 있도록 한다.
*   **구현 내용:**
    *   `app_gui.py`의 "Options" 프레임에 `ttk.Checkbutton`을 추가했다.
    *   `toggle_always_on_top` 메서드를 구현하여 체크박스 상태에 따라 `self.root.attributes("-topmost", True/False)`를 호출하도록 했다.

### 7.4. 재생 중 하이라이트 (Playback Highlight)

*   **목표:** 매크로 재생 시, 현재 실행 중인 액션이 편집기 목록에서 시각적으로 강조되어 사용자가 매크로의 진행 상황을 쉽게 파악할 수 있도록 한다.
*   **구현 내용:**
    *   `event_player.py`의 `Player` 클래스에 `on_action_highlight_callback`이라는 새로운 콜백 인자를 추가했다.
    *   `_play_events_task` 메서드에서 각 그룹화된 액션을 재생하기 직전에 `on_action_highlight_callback`을 호출하여 현재 재생 중인 액션의 인덱스를 `AppGUI`로 전달했다.
    *   `app_gui.py`에 `highlight_playing_action` 메서드를 구현하여 `Player`로부터 받은 인덱스를 이용해 `Treeview`의 해당 항목을 하이라이트하고, 이전에 하이라이트된 항목은 해제하도록 했다.
    *   GUI 스레드와 플레이어 스레드 간의 안전한 통신을 위해 `root.after()`를 사용하여 `Treeview` 업데이트가 GUI 스레드에서 이루어지도록 했다.

### 7.5. UI 레이아웃 개선

*   **목표:** 창의 폭을 넓히지 않고도 모든 UI 요소가 잘 보이도록 레이아웃을 최적화한다.
*   **구현 내용:**
    *   `app_gui.py`의 `__init__` 메서드에서 `Controls` 프레임과 `Options` 프레임의 배치를 `pack`에서 `grid`로 변경하여 `top_frame` 내에서 수직으로 배치되도록 했다. 이로써 `Options` 프레임이 화면 밖으로 넘어가는 문제를 해결했다.

### 7.6. 단축키 녹화 필터링 강화

*   **목표:** 녹화 시작/종료 시 사용되는 단축키(F5, F6, F7)와 그 모디파이어 키(Ctrl, Alt, Shift)가 매크로 데이터에 포함되어 재생 시 불필요한 키 입력이 발생하거나, 종료 후 키 눌림 현상이 발생하는 문제를 해결한다.
*   **구현 내용:**
    *   `app_gui.py`의 `toggle_recording` 메서드에서 `recorder.stop_recording()`으로 받은 `macro_data`를 후처리하는 로직을 추가했다.
    *   **녹화 시작 필터링:** 매크로 데이터의 시작 부분에서 `F5`, `F6`, `F7` 키와 `Ctrl`, `Alt`, `Shift` 모디파이어 키가 0.5초 이내에 발생한 모든 이벤트를 제거한다.
    *   **녹화 종료 필터링:** 매크로 데이터의 끝 부분에서 `F5`, `F6`, `F7` 키와 `Ctrl`, `Alt`, `Shift` 모디파이어 키가 0.5초 이내에 발생한 모든 이벤트를 제거한다. 특히 종료 시 남아있는 `Ctrl`, `Alt` `down` 이벤트로 인한 키 눌림 현상을 방지한다.

---

## 8. 향후 계획

*   **마우스 클릭 위치 보정:** 마우스 움직임(`Mouse Move`) 액션을 삭제하더라도, 그 이후의 마우스 클릭(`Mouse Click`, `Mouse Drag`) 액션은 삭제된 `Mouse Move` 액션 직전의 마우스 위치를 기준으로 클릭되도록 보정한다. 현재는 `Mouse Move`를 삭제하면 클릭 위치가 현재 마우스 위치로 고정되어 의도치 않은 곳을 클릭하게 된다.
*   **이벤트 시간 편집:**
    *   중간에 이벤트 삭제 시, 삭제된 이벤트의 소요 시간만큼 뒤이은 이벤트의 시작 시간을 당겨서 전체 매크로의 재생 시간을 단축하는 기능을 검토한다. (선택적 적용 가능성 포함)
    *   매크로 편집기에서 이벤트를 더블 클릭하면 상세 편집 창이 열리고, 해당 이벤트의 시간(딜레이)을 직접 수정할 수 있도록 한다. 상세 이벤트 수정이 어렵다면, 그룹화된 이벤트의 전체 시간을 늘리거나 줄일 수 있는 방법을 검토한다.
*   **재생 속도 조절 기능 구현:** GUI에 재생 속도 조절 UI를 추가하고, `event_player.py`에서 `time.sleep()` 값을 동적으로 조절하도록 한다.
*   **이미지 서치 기능 구현:** `pyautogui` 또는 `opencv-python`을 활용한 이미지 기반 매크로 기능을 추가한다.
*   **연속된 텍스트 입력 그룹화:** `Typing: "Hello World"`와 같이 연속된 키 입력을 하나의 액션으로 그룹화하는 기능을 구현한다.
*   **애플리케이션 아이콘 추가:** 프로그램의 완성도를 높이기 위해 아이콘을 추가한다.
*   **패키징:** 모든 기능이 안정화되면 최종 실행 파일로 패키징한다.